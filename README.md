# DataMonitorHost

## 简介

这是杭州电子科技大学电子信息学院专业综合实践设计课程作业“防火防盗监测器”项目的PC上位机部分，采用QT设计而成，主要功能有：

+ 支持TCP网络调试，可切换为客户端/服务器；
+ 网络传输采用JSON数据格式；
+ 实时显示[下位机](https://github.com/KenSporger/DataMonitorSlave)上报的数据，目前支持温度、加速度数据、陀螺仪数据、姿态角和报警信息；
+ 可通过曲线图可视化数据；
+ 能够读取和设置下位机相关参数，目前支持温度阈值、警报级别、报警时长和上传间隔；
+ 上位机可主动启用/关闭数据传输；

下位机项目地址：https://github.com/KenSporger/DataMonitorSlave



## 演示效果

![DataMonitorHost.gif](https://i.loli.net/2021/05/28/ci7deuMAKkwPSf3.gif)





## 快速使用

1. 下载源码，使用QT编译启动。
2. 在“网络调试”界面选择“TCP服务器”模式，配置本机地址和端口号，然后点击“开始侦听”，当有客户端成功接入后，右下角将显示当前连接的设备。
3. 切换至“防火防盗监测器”页面，点击“开始传输”按钮将开始监测数据。
4. 勾选“数据曲线图”下方的勾选框，将显示相应曲线。



## 疑难解答

### 下位机无法连接到服务器

+ **原因1**：有可能您在下位机中的地址和端口设置和服务器侦听的不一致，您需要确保两者的地址和端口配置相同。

+ **原因2**：下位机或者上位机未联网，请检查PC的网络设置以及下位机的WIFI连接情况。

+ **其他原因**：暂且不明，可试试重启。



### 下位机和服务器已连接，但无法收到数据

大概率是因为通信协议不对，下位机和服务器之间的通信数据需要严格遵守本项目的通信协议，比如是否忘加了回车符`\n`。下位机中如果通过`printf`的方式进行TCP数据帧发送，则要使用转义字符为键名添加引号。



### 数据传输很卡

+ **原因1**：网络不佳，可以增大上传间隔或者更换优质网络。
+ **原因2**：采用JSON数据格式本身增加了帧长度，可以通过减少键名长度来缓解卡顿。

+ **其他原因**：暂且不明，可试试重启。



## 二次开发

如果您想要在本项目的基础上实现进一步的开发，您应当了解一下本项目代码的一些基本情况。



### UI设计

如果您想要添加更多的控件或者更改页面布局，可以修改`mainwindow.ui`。



### 通信协议

本项目使用JSON作为通信数据格式，上位机接收的数据帧以`\n`字符作为结束标识符，您可以更改为其他字符，只要修改`ServerReadData`函数中的一行代码即可。

```C++
while((pos = strRecv.indexOf('\n')) != -1)
```

下位机接收的数据帧以`{`和`}`作为一帧标志，故服务器下发数据时不需要添加`\n`字符。

数据帧包含固定键`type`，用于区分数据帧的类型，本项目设置了5种帧类型，分别为：

+ `DATA_LOAD`：下位机上报给服务器的数据帧，包含温度、姿态角信息等。例如：

  ```json
  {"type":0,"temp":28.5,"ax":64,"ay":304,"az":17714,"gx":0,"gy":1,"gz":-1,"roll":0.1,"pitch":0.5,"yaw":-0.5,"warning":0}\n
  ```

+ `PARAM_LOAD`：下位机上报给服务器的参数帧，包含温度上限、报警时长等。例如：

  ```json
  {"type":1,"max_temp":35,"shake_level":5,"warning_time":3,"upload_time":1.0}\n
  ```

+ `CMD_PARAM_LOAD`：服务器下发给下位机的参数读取帧。例如：

  ```json
  {"type":2}
  ```

+ `CMD_DATA_LOAD`：服务器下发给下位机的数据传输控制帧。例如：

  ```json
  {"type":3,"wifi_upload":1}  // 开始传输
  {"type":3,"wifi_upload":0}	// 停止传输
  ```

+ `PARAM_SET`：服务器下发给下位机的参数设置帧。例如：

  ```json
  {"type":4,"max_temp":35,"shake_level":5,"warning_time":3,"upload_time":1.0}
  ```

您可以在枚举体`FrameType`中添加自己的帧类型。

```c++
enum FrameType
{
    DATA_LOAD = 0,
    PARAM_LOAD = 1,
    CMD_PARAM_LOAD =2,
    CMD_DATA_LOAD = 3,
    PARAM_SET = 4
};
```



### 数据处理

数据处理主要在函数`frameProc`中完成，借助`QJson`可以直接解析数据帧，然后通过键值查询的方式来获取数值，例如：

```c++
data_pack.ax = obj["ax"].toInt();
```

获取数值之后，您可以选择将本次数据添加到曲线图中，

```c++
myChart.addNewPoint("temp", data_pack.temp)
```

在添加完所有数据点之后，您需要额外调用`updateFrame()`通知图表一帧的结束。



### 数据收发

服务器模式的数据接收函数为`ServerReadData`，客户端模式的接收函数为`ReadData`，两种模式的发送函数都为`SendData`。

服务器模式支持多个设备同时接入，并且可以在收发数据时选择单个设备或全部设备。



### 数据曲线

本项目使用了`QChart`来完成曲线图的绘制，我们在`chart.cpp`中做了简单的封装，提供了以下接口：

+ `createNewSerie`：添加一个新的曲线系列，需要指定唯一标识名、曲线颜色以及数值最大范围。
+ `addNewPoint`：通过唯一标识名向某个曲线系列添加一个新的数据点。
+ `updateFrame`：更新曲线图（主要是变动X轴的显式范围）。
+ `enableSerie`：显示某个曲线系列。
+ `disableSerie`：隐藏某个曲线系列。

此外，我们在`updateAxisY`函数中实现了Y轴范围的动态变化，以适应不同曲线系列的数据范围，您可以选择在代码中注释掉它的调用，并调整`default_minX`和`default_maxY`的值来容纳您所有的曲线。





